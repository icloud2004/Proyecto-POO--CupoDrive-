<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CupoDrive - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { min-height: 100vh; }
      .sidebar { width: 240px; }
      .content { margin-left: 250px; padding: 20px; }
      .pointer { cursor: pointer; }
      .campus-badge { font-size: 0.85rem; margin-left: 8px; }
    </style>
  </head>
  <body>
    <nav class="navbar bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">CupoDrive - Admin</a>
        <div class="d-flex">
          <span class="navbar-text text-light me-3">Bienvenido, {{ user.name }}</span>
          <button id="logoutBtn" class="btn btn-outline-light btn-sm">Cerrar sesión</button>
        </div>
      </div>
    </nav>

    <div class="d-flex">
      <div class="bg-light sidebar position-fixed vh-100 p-3">
        <h6>Menu</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="#" class="nav-link" id="menuUpload">Subir CSV</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuCupos">Gestionar Cupos</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuAspirantes">Ver Aspirantes</a></li>
        </ul>
      </div>

      <div class="content flex-fill">
        <!-- Upload panel -->
        <div id="panelUpload">
          <h4>Subir archivos CSV</h4>
          <form id="uploadForm">
            <div class="mb-3">
              <label class="form-label">Archivo aspirantes (BaseDatos.csv)</label>
              <input id="fileAspirantes" name="aspirantes" type="file" class="form-control" accept=".csv">
            </div>
            <div class="mb-3">
              <label class="form-label">Archivo carreras (Carreras.csv)</label>
              <input id="fileCarreras" name="carreras" type="file" class="form-control" accept=".csv">
            </div>
            <button id="btnUpload" type="button" class="btn btn-primary">Subir y cargar</button>
            <span class="mx-2"></span>
            <button id="btnAssignAll" type="button" class="btn btn-success">Asignar cupos automáticamente</button>
            <button id="btnReport" type="button" class="btn btn-outline-secondary">Generar reporte</button>
          </form>
          <hr>
        </div>

        <!-- Cupos panel -->
        <div id="panelCupos" style="display:none;">
          <h4>Gestionar Cupos</h4>
          <div id="carrerasContainer" class="mb-3"></div>
          <div id="cuposContainer"></div>
        </div>

        <div id="panelAspirantes" style="display:none;">
          <h4>Lista de Aspirantes</h4>
          <table class="table table-sm" id="tableAspirantes">
            <thead><tr><th>Cédula</th><th>Nombre</th><th>Puntaje</th><th>Estado</th></tr></thead>
            <tbody><tr><td colspan="4">Carga los aspirantes para ver la lista.</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal editar cupos -->
    <div class="modal fade" id="modalEditarCupos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar cantidad de cupos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="formEditarCupos">
              <div class="mb-3">
                <label class="form-label">Carrera</label>
                <input id="editCarreraNombre" type="text" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Campus</label>
                <input id="editCarreraCampus" type="text" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Cupos actuales</label>
                <input id="editCuposActuales" type="number" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Nueva cantidad de cupos</label>
                <input id="editNuevaOferta" type="number" min="0" class="form-control" required>
              </div>
              <div id="editError" class="alert alert-danger d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="btnGuardarCupos" type="button" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal ver detalles de carrera / cupos -->
    <div class="modal fade" id="modalVerCupos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalVerCuposTitle">Cupos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="modalCuposBody"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // helper fetch que incluye cookies
      async function api(path, opts = {}) {
        const fetchOpts = Object.assign({ credentials: 'include' }, opts);
        const res = await fetch(path, fetchOpts);
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (e) { data = null; }
        if (!res.ok) {
          throw new Error((data && data.error) ? data.error : (text || res.statusText));
        }
        return data;
      }

      // Navegación de paneles
      document.getElementById('menuUpload')?.addEventListener('click', () => {
        document.getElementById('panelUpload').style.display = 'block';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'none';
      });
      document.getElementById('menuCupos')?.addEventListener('click', async () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'block';
        document.getElementById('panelAspirantes').style.display = 'none';
        await cargarColegios();
      });
      document.getElementById('menuAspirantes')?.addEventListener('click', async () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'block';
        await cargarAspirantes();
      });

      // Upload
      document.getElementById('btnUpload')?.addEventListener('click', async () => {
        const form = document.getElementById('uploadForm');
        const fd = new FormData();
        const fAsp = document.getElementById('fileAspirantes').files[0];
        const fCarr = document.getElementById('fileCarreras').files[0];
        if (fAsp) fd.append('aspirantes', fAsp);
        if (fCarr) fd.append('carreras', fCarr);
        try {
          const res = await fetch('/admin/upload', { method: 'POST', body: fd, credentials: 'include' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error al subir');
          alert('Archivos subidos correctamente.');
        } catch (e) {
          alert('Error: ' + e.message);
        }
      });

      // Assign all
      document.getElementById('btnAssignAll')?.addEventListener('click', async () => {
        if (!confirm('¿Asignar cupos automáticamente a todas las carreras?')) return;
        try {
          const res = await api('/admin/assign', { method: 'POST' });
          alert('Asignación finalizada.');
          await cargarColegios();
        } catch (e) {
          alert('Error al asignar: ' + e.message);
        }
      });

      // Report
      document.getElementById('btnReport')?.addEventListener('click', async () => {
        try {
          const res = await api('/admin/report', { method: 'POST' });
          alert('Reporte generado (si todo salió bien).');
        } catch (e) {
          alert('Error al generar reporte: ' + e.message);
        }
      });

      // Cargar carreras y mostrarlas en la UI con botones
      async function cargarColegios() {
        try {
          const carreras = await api('/api/carreras', { method: 'GET' });
          const container = document.getElementById('carrerasContainer');
          container.innerHTML = '';
          if (!carreras || carreras.length === 0) {
            container.innerHTML = '<p>No hay carreras cargadas.</p>';
            return;
          }
          carreras.forEach(c => {
            const div = document.createElement('div');
            div.className = 'mb-3 d-flex justify-content-between align-items-center';
            const campusText = c.campus ? `<span class="badge bg-info text-dark campus-badge">${c.campus}</span>` : '';
            div.innerHTML = `
              <div>
                <strong>${c.nombre}</strong> ${campusText}<br>
                <small>Cupos: <span id="cupos-${c.id}">${c.oferta_cupos}</span> — Asignados: ${c.cupos_asignados}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2 btn-ver-cupos" data-id="${c.id}" data-nombre="${c.nombre}" data-campus="${c.campus || ''}">Ver cupos</button>
                <button class="btn btn-sm btn-outline-secondary me-2 btn-editar-cupos" data-id="${c.id}" data-nombre="${c.nombre}" data-oferta="${c.oferta_cupos}" data-campus="${c.campus || ''}">Editar cupos</button>
                <button class="btn btn-sm btn-outline-danger btn-eliminar-cupos" data-id="${c.id}">Eliminar todos cupos</button>
              </div>
            `;
            container.appendChild(div);
          });

          // Attach event listeners to newly created buttons
          document.querySelectorAll('.btn-editar-cupos').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = btn.getAttribute('data-id');
              const nombre = btn.getAttribute('data-nombre');
              const oferta = btn.getAttribute('data-oferta');
              const campus = btn.getAttribute('data-campus') || '';
              abrirModalEditar(id, nombre, oferta, campus);
            });
          });

          document.querySelectorAll('.btn-ver-cupos').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const nombre = btn.getAttribute('data-nombre');
              const campus = btn.getAttribute('data-campus') || '';
              try {
                const data = await api(`/api/carreras/${encodeURIComponent(id)}/cupos`, { method: 'GET' });
                // mostrar en modal
                const cont = document.getElementById('modalCuposBody');
                document.getElementById('modalVerCuposTitle').textContent = `Cupos para ${nombre} ${campus ? '(' + campus + ')' : ''}`;
                cont.innerHTML = '';
                if (!data || !data.cupos || data.cupos.length === 0) {
                  cont.innerHTML = '<p>No hay cupos para esta carrera.</p>';
                } else {
                  const table = document.createElement('table');
                  table.className = 'table table-sm';
                  table.innerHTML = '<thead><tr><th>ID</th><th>Estado</th><th>Aspirante</th><th>Acciones</th></tr></thead>';
                  const tb = document.createElement('tbody');
                  data.cupos.forEach(cc => {
                    const tr = document.createElement('tr');
                    const aspirName = cc.aspirante ? (cc.aspirante.nombre || cc.aspirante.nombre || '') : '';
                    tr.innerHTML = `<td>${cc.id_cupo}</td><td>${cc.estado}</td><td>${aspirName}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger btn-delete-cupo" data-id="${cc.id_cupo}">Eliminar</button>
                        <button class="btn btn-sm btn-outline-warning btn-liberar-cupo" data-id="${cc.id_cupo}">Liberar</button>
                      </td>`;
                    tb.appendChild(tr);
                  });
                  table.appendChild(tb);
                  cont.appendChild(table);

                  // attach delete/liberar handlers
                  document.querySelectorAll('.btn-delete-cupo').forEach(b => {
                    b.addEventListener('click', async () => {
                      if (!confirm('¿Eliminar este cupo?')) return;
                      try {
                        await api(`/api/cupos/${encodeURIComponent(b.getAttribute('data-id'))}`, { method: 'DELETE' });
                        await cargarColegios();
                        // refresh modal content
                        btn.click();
                      } catch (e) {
                        alert('Error: ' + e.message);
                      }
                    });
                  });
                  document.querySelectorAll('.btn-liberar-cupo').forEach(b => {
                    b.addEventListener('click', async () => {
                      if (!confirm('¿Liberar este cupo?')) return;
                      try {
                        await api(`/api/cupos/${encodeURIComponent(b.getAttribute('data-id'))}/liberar`, { method: 'POST' });
                        await cargarColegios();
                        btn.click();
                      } catch (e) {
                        alert('Error: ' + e.message);
                      }
                    });
                  });
                }

                const modalView = new bootstrap.Modal(document.getElementById('modalVerCupos'));
                modalView.show();
              } catch (e) {
                alert('Error al obtener cupos: ' + e.message);
              }
            });
          });

          // --------- NUEVO HANDLER: Eliminar todos los cupos (usa endpoint DELETE dedicado) ----------
          document.querySelectorAll('.btn-eliminar-cupos').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('¿Eliminar todos los cupos de esta carrera? Esta acción puede afectar asignaciones.')) return;
              const id = btn.getAttribute('data-id');
              if (!id) return alert('Identificador de carrera no disponible.');

              try {
                // Llamada directa al endpoint DELETE dedicado (mejor que borrar cupo por cupo)
                await api(`/api/carreras/${encodeURIComponent(id)}/cupos`, { method: 'DELETE' });
                alert('Cupos eliminados.');
                await cargarColegios();
              } catch (e) {
                // Fallback: intentar borrar cupo por cupo si el endpoint DELETE no existe
                try {
                  const data = await api(`/api/carreras/${encodeURIComponent(id)}/cupos`, { method: 'GET' });
                  if (data && data.cupos) {
                    for (const cup of data.cupos) {
                      await api(`/api/cupos/${encodeURIComponent(cup.id_cupo)}`, { method: 'DELETE' });
                    }
                  }
                  alert('Cupos eliminados (fallback).');
                  await cargarColegios();
                } catch (err) {
                  alert('Error al eliminar cupos: ' + (err.message || err));
                }
              }
            });
          });
          // -----------------------------------------------------------------------------------------

        } catch (e) {
          console.error(e);
          alert('Error cargando carreras: ' + e.message);
        }
      }

      // Modal helpers
      let carreraEditarId = null;
      const modalEditar = new bootstrap.Modal(document.getElementById('modalEditarCupos'));
      function abrirModalEditar(id, nombre, oferta, campus) {
        carreraEditarId = id;
        document.getElementById('editCarreraNombre').value = nombre;
        document.getElementById('editCarreraCampus').value = campus || '—';
        document.getElementById('editCuposActuales').value = oferta;
        document.getElementById('editNuevaOferta').value = oferta;
        document.getElementById('editError').classList.add('d-none');
        modalEditar.show();
      }

      document.getElementById('btnGuardarCupos')?.addEventListener('click', async () => {
        const nueva = parseInt(document.getElementById('editNuevaOferta').value);
        if (isNaN(nueva) || nueva < 0) {
          document.getElementById('editError').textContent = 'Introduce un número válido de cupos.';
          document.getElementById('editError').classList.remove('d-none');
          return;
        }
        try {
          const res = await api(`/api/carreras/${encodeURIComponent(carreraEditarId)}/update_oferta`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nueva_oferta: nueva })
          });
          if (res && res.ok) {
            modalEditar.hide();
            await cargarColegios();
            alert('Oferta actualizada correctamente.');
          } else {
            document.getElementById('editError').textContent = (res && res.error) ? res.error : 'No se pudo actualizar.';
            document.getElementById('editError').classList.remove('d-none');
          }
        } catch (e) {
          document.getElementById('editError').textContent = e.message;
          document.getElementById('editError').classList.remove('d-none');
        }
      });

      // Cargar aspirantes (panel)
      async function cargarAspirantes() {
        try {
          const list = await api('/api/aspirantes', { method: 'GET' });
          const tbody = document.querySelector('#tableAspirantes tbody');
          tbody.innerHTML = '';
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No hay aspirantes.</td></tr>';
            return;
          }
          list.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.cedula}</td><td>${a.nombre}</td><td>${a.puntaje}</td><td>${a.estado}</td>`;
            tbody.appendChild(tr);
          });
        } catch (e) {
          alert('Error cargando aspirantes: ' + e.message);
        }
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/logout', { method: 'POST', credentials: 'include' });
        } finally {
          window.location = '/';
        }
      });

      // Arranque: seleccionar panel upload por defecto
      document.getElementById('menuUpload').click();
    </script>
  </body>
</html>