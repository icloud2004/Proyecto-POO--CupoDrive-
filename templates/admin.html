<!-- Añadimos dentro de la sección admin (ya existente) un botón para gestionar segmentos y un modal -->
<button id="btnManageSegments" class="btn btn-outline-info">Configurar segmentos</button>

<!-- Modal gestión de segmentos -->
<div class="modal fade" id="modalSegments" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configurar segmentos por carrera</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formSegments">
          <div class="mb-3">
            <label for="selectCarrera" class="form-label">Carrera</label>
            <select id="selectCarrera" class="form-select"></select>
          </div>

          <div id="segmentsList" class="mb-3">
            <!-- aquí se listarán los segmentos existentes con inputs de porcentaje -->
          </div>

          <div class="mb-3">
            <button id="btnAddSegment" type="button" class="btn btn-sm btn-secondary">Añadir segmento</button>
          </div>

          <div id="segmentsWarning" class="alert alert-warning d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="btnSaveSegments" type="button" class="btn btn-primary">Guardar configuración</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Esqueleto JS: funciones para cargar carreras, mostrar segmentos y validar porcentajes.
  async function mostrarModalSegments() {
    const select = document.getElementById("selectCarrera");
    select.innerHTML = '<option value="">Cargando...</option>';
    try {
      const res = await fetch('/api/carreras');
      const carreras = await res.json();
      select.innerHTML = carreras.map(c=>`<option value="${c.id_carrera}">${c.nombre}</option>`).join('');
      if (carreras.length) {
        select.value = carreras[0].id_carrera;
        cargarSegmentos(carreras[0].id_carrera);
      }
      const modal = new bootstrap.Modal(document.getElementById('modalSegments'));
      modal.show();
    } catch (e) {
      alert('No fue posible cargar las carreras: ' + e.message);
    }
  }

  async function cargarSegmentos(carreraId) {
    const container = document.getElementById("segmentsList");
    container.innerHTML = 'Cargando...';
    const warning = document.getElementById("segmentsWarning");
    warning.classList.add('d-none');
    try {
      const res = await fetch('/api/carreras/' + carreraId + '/segmentos');
      const segs = await res.json();
      renderSegmentInputs(segs);
    } catch (e) {
      container.innerHTML = '<div class="text-danger">Error cargando segmentos</div>';
    }
  }

  function renderSegmentInputs(segs) {
    const container = document.getElementById("segmentsList");
    container.innerHTML = '';
    segs.forEach((s, idx) => {
      const id = 'seg_' + idx;
      container.insertAdjacentHTML('beforeend', `
        <div class="d-flex mb-2 align-items-center" data-idx="${idx}">
          <input class="form-control me-2" value="${s.nombre}" data-field="nombre" placeholder="Nombre segmento">
          <input type="number" class="form-control me-2" value="${s.porcentaje}" data-field="porcentaje" min="0" max="100" step="0.1" style="width:120px">
          <button class="btn btn-sm btn-danger btnRemoveSegment">Eliminar</button>
        </div>
      `);
    });

    document.querySelectorAll('.btnRemoveSegment').forEach(b=>{
      b.onclick = function(){
        this.closest('[data-idx]').remove();
        validarSuma();
      };
    });

    document.querySelectorAll('[data-field="porcentaje"]').forEach(inp=>{
      inp.oninput = validarSuma;
    });

    validarSuma();
  }

  function validarSuma() {
    const warning = document.getElementById("segmentsWarning");
    const inputs = document.querySelectorAll('[data-field="porcentaje"]');
    let suma = 0;
    inputs.forEach(i=>{ suma += parseFloat(i.value || 0); });
    if (suma > 100.0001) {
      warning.classList.remove('d-none');
      warning.textContent = `La suma de porcentajes excede 100% (actual ${suma.toFixed(2)}%). Corrige antes de guardar.`;
      return false;
    } else {
      warning.classList.remove('d-none');
      warning.textContent = `Suma actual ${suma.toFixed(2)}%. Si es menor a 100% el sistema añadirá la diferencia a 'Población general' automáticamente.`;
      return true;
    }
  }

  document.getElementById('btnManageSegments')?.addEventListener('click', mostrarModalSegments);
  document.getElementById('btnAddSegment')?.addEventListener('click', function(){
    const container = document.getElementById("segmentsList");
    const idx = container.children.length;
    container.insertAdjacentHTML('beforeend', `
      <div class="d-flex mb-2 align-items-center" data-idx="${idx}">
        <input class="form-control me-2" value="Nuevo segmento" data-field="nombre" placeholder="Nombre segmento">
        <input type="number" class="form-control me-2" value="0" data-field="porcentaje" min="0" max="100" step="0.1" style="width:120px">
        <button class="btn btn-sm btn-danger btnRemoveSegment">Eliminar</button>
      </div>
    `);
    document.querySelectorAll('.btnRemoveSegment').forEach(b=>{ b.onclick = function(){ this.closest('[data-idx]').remove(); validarSuma(); }; });
  });

  document.getElementById('btnSaveSegments')?.addEventListener('click', async function(){
    const carreraId = document.getElementById('selectCarrera').value;
    const rows = Array.from(document.querySelectorAll('#segmentsList > div[data-idx]'));
    const payload = rows.map(r=>({
      nombre: r.querySelector('[data-field="nombre"]').value.trim(),
      porcentaje: parseFloat(r.querySelector('[data-field="porcentaje"]').value || 0)
    }));
    let suma = payload.reduce((s, x) => s + (x.porcentaje || 0), 0);
    if (suma > 100.0001) { alert('La suma de porcentajes excede 100%. Corrige antes de guardar.'); return; }
    try {
      const res = await fetch('/api/carreras/' + carreraId + '/segmentos', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({segmentos: payload}) });
      if (!res.ok) throw new Error(await res.text());
      alert('Configuración guardada correctamente.');
      const modalEl = document.getElementById('modalSegments');
      bootstrap.Modal.getInstance(modalEl).hide();
    } catch (e) { alert('Error guardando configuración: ' + e.message); }
  });
</script>
