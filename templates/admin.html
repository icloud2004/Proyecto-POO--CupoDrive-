
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CupoDrive - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { min-height: 100vh; }
      .sidebar { width: 240px; }
      .content { margin-left: 250px; padding: 20px; }
      .pointer { cursor: pointer; }
      .campus-badge { font-size: 0.85rem; margin-left: 8px; }
      pre.json { background:#0b1220; color:#e5e7eb; padding:12px; border-radius:10px; }
      .muted { color:#6b7280; }
    </style>
  </head>
  <body>
    <nav class="navbar bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">CupoDrive - Admin</a>
        <div class="d-flex">
          <span class="navbar-text text-light me-3">Bienvenido, {{ user.name }}</span>
          <button id="logoutBtn" class="btn btn-outline-light btn-sm">Cerrar sesión</button>
        </div>
      </div>
    </nav>

    <div class="d-flex">
      <div class="bg-light sidebar position-fixed vh-100 p-3">
        <h6>Menu</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="#" class="nav-link" id="menuUpload">Subir CSV</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuCupos">Gestionar Cupos</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuAspirantes">Ver Aspirantes</a></li>
        </ul>
      </div>

      <div class="content flex-fill">
        <!-- Upload panel -->
        <div id="panelUpload">
          <h4>Subir archivos CSV</h4>

          <form id="uploadForm">
            <div class="mb-3">
              <label class="form-label">Archivo aspirantes (BaseDatos.csv)</label>
              <input id="fileAspirantes" name="aspirantes" type="file" class="form-control" accept=".csv">
            </div>

            <div class="mb-3">
              <label class="form-label">Archivo carreras (Carreras.csv)</label>
              <input id="fileCarreras" name="carreras" type="file" class="form-control" accept=".csv">
            </div>

            <div class="mb-3">
              <button id="btnManageGlobalSegments" type="button" class="btn btn-outline-warning">
                Gestionar segmentos globales
              </button>
              <div class="form-text">
                Los segmentos globales aplican a todas las carreras (suma debe ser 100%).
              </div>
            </div>

            <hr>

            <h6 class="mt-3">Período académico activo</h6>

            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <input id="periodoAnio" class="form-control" placeholder="Año (ej. 2025)">
              </div>

              <div class="col-md-5">
                <input id="periodoNombre" class="form-control" placeholder="Período (ej. Primer Semestre)">
              </div>

              <div class="col-md-2">
                <button id="btnGuardarPeriodo" type="button" class="btn btn-outline-primary">
                  Guardar período
                </button>
              </div>
            </div>

            <button id="btnUpload" type="button" class="btn btn-primary">
              Subir y cargar
            </button>

            <span class="mx-2"></span>

            <button id="btnAssignAll" type="button" class="btn btn-success">
              Asignar cupos automáticamente
            </button>

            <button id="btnReport" type="button" class="btn btn-outline-secondary">
              Generar reporte
            </button>

          </form>

          <hr>
        </div>

        <!-- Cupos panel -->
        <div id="panelCupos" style="display:none;">
          <h4>Gestionar Cupos</h4>
          <div id="carrerasContainer" class="mb-3"></div>
          <div id="cuposContainer"></div>
        </div>

        <div id="panelAspirantes" style="display:none;">
          <h4>Lista de Aspirantes</h4>
          <table class="table table-sm" id="tableAspirantes">
            <thead><tr><th>Cédula</th><th>Nombre</th><th>Puntaje</th><th>Estado</th></tr></thead>
            <tbody><tr><td colspan="4">Carga los aspirantes para ver la lista.</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal editar cupos -->
    <div class="modal fade" id="modalEditarCupos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar cantidad de cupos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="formEditarCupos">
              <div class="mb-3">
                <label class="form-label">Carrera</label>
                <input id="editCarreraNombre" type="text" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Campus</label>
                <input id="editCarreraCampus" type="text" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Cupos actuales</label>
                <input id="editCuposActuales" type="number" class="form-control" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">Nueva cantidad de cupos</label>
                <input id="editNuevaOferta" type="number" min="0" class="form-control" required>
              </div>
              <div id="editError" class="alert alert-danger d-none"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button id="btnGuardarCupos" type="button" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal ver cupos -->
    <div class="modal fade" id="modalVerCupos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalVerCuposTitle">Cupos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="muted">Tip: usa “Ver info” para ver el detalle del aspirante.</div>
              <input id="cuposSearch" class="form-control form-control-sm" style="max-width:280px" placeholder="Buscar por cédula o nombre...">
            </div>
            <div id="modalCuposBody"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal info aspirante -->
    <div class="modal fade" id="modalInfoAspirante" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Información del aspirante</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="aspCard" class="border rounded-3 p-3">
              <div class="d-flex justify-content-between flex-wrap gap-2">
                <div>
                  <h6 class="mb-0" id="aspNombre">—</h6>
                  <div class="muted">Cédula: <span id="aspCedula">—</span></div>
                </div>
                <div class="text-end">
                  <div class="muted">Puntaje</div>
                  <div class="fs-5 fw-semibold" id="aspPuntaje">—</div>
                </div>
              </div>
              <hr>
              <div class="row g-2">
                <div class="col-md-4"><div class="muted">Estado</div><div id="aspEstado">—</div></div>
                <div class="col-md-4"><div class="muted">Segmento</div><div id="aspSegmento">—</div></div>
                <div class="col-md-4"><div class="muted">Prioridad</div><div id="aspPrioridad">—</div></div>
                <div class="col-md-6"><div class="muted">Carrera postulada</div><div id="aspCarrera">—</div></div>
                <div class="col-md-6"><div class="muted">Campus</div><div id="aspCampus">—</div></div>
              </div>
              <hr>
              <details>
                <summary class="pointer">Ver JSON completo</summary>
                <pre class="json mt-2" id="aspiranteInfoPre">{}</pre>
              </details>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal gestionar segmentos globales -->
    <div class="modal fade" id="modalSegmentosGlobal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Segmentos globales (aplican a todas las carreras)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div id="segmentosGlobalList"></div>
            <hr>
            <h6>Añadir / Editar segmento</h6>
            <form id="formSegmentoGlobal">
              <div class="row g-2">
                <div class="col-md-5">
                  <input id="gsegNombre" class="form-control" placeholder="Nombre del segmento" required>
                </div>
                <div class="col-md-3">
                  <input id="gsegPorcentaje" type="number" min="0" max="100" step="0.1" class="form-control" placeholder="Porcentaje (%)" required>
                </div>
                <div class="col-md-2">
                  <input id="gsegOrden" type="number" min="1" class="form-control" placeholder="Orden" required>
                </div>
                <div class="col-md-2">
                  <button id="btnAddGSeg" class="btn btn-primary">Añadir/Actualizar</button>
                </div>
              </div>
            </form>
            <div id="gsegError" class="alert alert-danger mt-3 d-none"></div>
            <div class="form-text mt-2">La suma de porcentajes debe ser exactamente 100%</div>
          </div>
          <div class="modal-footer">
            <button id="btnSaveGSeg" type="button" class="btn btn-success">Guardar segmentos globales</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // helper fetch que incluye cookies
      async function api(path, opts = {}) {
        const fetchOpts = Object.assign({ credentials: 'include' }, opts);
        const res = await fetch(path, fetchOpts);
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (e) { data = null; }
        if (!res.ok) {
          throw new Error((data && data.error) ? data.error : (text || res.statusText));
        }
        return data;
      }

      // Navegación de paneles
      document.getElementById('menuUpload')?.addEventListener('click', () => {
        document.getElementById('panelUpload').style.display = 'block';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'none';
      });

      document.getElementById('menuCupos')?.addEventListener('click', async () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'block';
        document.getElementById('panelAspirantes').style.display = 'none';
        await cargarColegios();
      });

      document.getElementById('menuAspirantes')?.addEventListener('click', async () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'block';
        await cargarAspirantes();
      });

      // Open global segments modal
      document.getElementById('btnManageGlobalSegments')?.addEventListener('click', async () => {
        abrirModalSegmentosGlobal();
      });

      // Upload
      document.getElementById('btnUpload')?.addEventListener('click', async () => {
        const fd = new FormData();
        const fAsp = document.getElementById('fileAspirantes').files[0];
        const fCarr = document.getElementById('fileCarreras').files[0];
        if (fAsp) fd.append('aspirantes', fAsp);
        if (fCarr) fd.append('carreras', fCarr);
        try {
          const res = await fetch('/admin/upload', { method: 'POST', body: fd, credentials: 'include' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Error al subir');
          alert('Archivos subidos correctamente.');
        } catch (e) {
          alert('Error: ' + e.message);
        }
      });

      // Assign all
      document.getElementById('btnAssignAll')?.addEventListener('click', async () => {
        if (!confirm('¿Asignar cupos automáticamente a todas las carreras?')) return;
        try {
          await api('/admin/assign', { method: 'POST' });
          alert('Asignación finalizada.');
          await cargarColegios();
        } catch (e) {
          alert('Error al asignar: ' + e.message);
        }
      });

      // Cargar carreras y mostrarlas
      async function cargarColegios() {
        try {
          const carreras = await api('/api/carreras', { method: 'GET' });
          const container = document.getElementById('carrerasContainer');
          container.innerHTML = '';

          if (!carreras || carreras.length === 0) {
            container.innerHTML = '<p>No hay carreras cargadas.</p>';
            return;
          }

          carreras.forEach(c => {
            const div = document.createElement('div');
            div.className = 'mb-3 d-flex justify-content-between align-items-center';

            const campusText = c.campus
              ? `<span class="badge bg-info text-dark campus-badge">${c.campus}</span>`
              : '';

            div.innerHTML = `
              <div>
                <strong>${c.nombre}</strong> ${campusText}<br>
                <small>Cupos: <span id="cupos-${c.id}">${c.oferta_cupos}</span> — Asignados: ${c.cupos_asignados}</small>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2 btn-ver-cupos"
                  data-id="${c.id}" data-nombre="${c.nombre}" data-campus="${c.campus || ''}">
                  Ver cupos
                </button>
                <button class="btn btn-sm btn-outline-secondary me-2 btn-editar-cupos"
                  data-id="${c.id}" data-nombre="${c.nombre}" data-oferta="${c.oferta_cupos}" data-campus="${c.campus || ''}">
                  Editar cupos
                </button>
                <button class="btn btn-sm btn-outline-danger btn-eliminar-cupos" data-id="${c.id}">
                  Eliminar todos cupos
                </button>
              </div>
            `;
            container.appendChild(div);
          });

          document.querySelectorAll('.btn-editar-cupos').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-id');
              const nombre = btn.getAttribute('data-nombre');
              const oferta = btn.getAttribute('data-oferta');
              const campus = btn.getAttribute('data-campus') || '';
              abrirModalEditar(id, nombre, oferta, campus);
            });
          });

          document.querySelectorAll('.btn-ver-cupos').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-id');
              const nombre = btn.getAttribute('data-nombre');
              const campus = btn.getAttribute('data-campus') || '';

              try {
                const data = await api(`/api/carreras/${encodeURIComponent(id)}/cupos`, { method: 'GET' });

                const cont = document.getElementById('modalCuposBody');
                document.getElementById('modalVerCuposTitle').textContent =
                  `Cupos para ${nombre} ${campus ? '(' + campus + ')' : ''}`;

                cont.innerHTML = '';

                if (!data || !data.cupos || data.cupos.length === 0) {
                  cont.innerHTML = '<p>No hay cupos para esta carrera.</p>';
                } else {
                  const table = document.createElement('table');
                  table.className = 'table table-sm align-middle';
                  table.innerHTML = '<thead><tr><th>ID</th><th>Estado</th><th>Aspirante</th><th style="width:280px">Acciones</th></tr></thead>';

                  const tb = document.createElement('tbody');

                  // Cache para búsqueda
                  window.__cuposRows = [];

                  data.cupos.forEach(cc => {
                    const tr = document.createElement('tr');

                    const aspNombre = cc.aspirante ? (cc.aspirante.nombre || '') : '';
                    const aspCedula = cc.aspirante ? (cc.aspirante.cedula || '') : '';
                    const aspTexto = aspNombre ? `${aspNombre} (${aspCedula})` : '—';

                    tr.dataset.search = (aspNombre + " " + aspCedula).toLowerCase();

                    tr.innerHTML = `
                      <td>${cc.id_cupo}</td>
                      <td>${cc.estado}</td>
                      <td>${aspTexto}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger btn-delete-cupo" data-id="${cc.id_cupo}">Eliminar</button>
                        <button class="btn btn-sm btn-outline-warning btn-liberar-cupo" data-id="${cc.id_cupo}">Liberar</button>
                        ${aspCedula ? `<button class="btn btn-sm btn-outline-info btn-info-asp" data-cedula="${aspCedula}">Ver info</button>` : ''}
                      </td>
                    `;

                    tb.appendChild(tr);
                    window.__cuposRows.push(tr);
                  });

                  table.appendChild(tb);
                  cont.appendChild(table);

                  // Búsqueda
                  const search = document.getElementById('cuposSearch');
                  if (search) {
                    search.value = '';
                    search.oninput = () => {
                      const q = (search.value || '').trim().toLowerCase();
                      window.__cuposRows.forEach(row => {
                        const ok = row.dataset.search.includes(q);
                        row.style.display = ok ? '' : 'none';
                      });
                    };
                  }

                  // delete handlers
                  cont.querySelectorAll('.btn-delete-cupo').forEach(b => {
                    b.addEventListener('click', async () => {
                      if (!confirm('¿Eliminar este cupo?')) return;
                      try {
                        await api(`/api/cupos/${encodeURIComponent(b.getAttribute('data-id'))}`, { method: 'DELETE' });
                        await cargarColegios();
                        btn.click(); // refresca modal
                      } catch (e) {
                        alert('Error: ' + e.message);
                      }
                    });
                  });

                  // liberar handlers
                  cont.querySelectorAll('.btn-liberar-cupo').forEach(b => {
                    b.addEventListener('click', async () => {
                      if (!confirm('¿Liberar este cupo?')) return;
                      try {
                        await api(`/api/cupos/${encodeURIComponent(b.getAttribute('data-id'))}/liberar`, { method: 'POST' });
                        await cargarColegios();
                        btn.click(); // refresca modal
                      } catch (e) {
                        alert('Error: ' + e.message);
                      }
                    });
                  });

                  // ver info aspirante
                  cont.querySelectorAll('.btn-info-asp').forEach(b => {
                    b.addEventListener('click', async () => {
                      const ced = b.getAttribute('data-cedula');
                      if (!ced) return;

                      try {
                        const res = await api(`/api/aspirantes/${encodeURIComponent(ced)}`, { method: 'GET' });
                        const a = res.aspirante || {};

                        document.getElementById('aspNombre').textContent = a.nombre || '—';
                        document.getElementById('aspCedula').textContent = a.cedula || ced || '—';
                        document.getElementById('aspPuntaje').textContent = (a.puntaje ?? a.puntaje_postulacion ?? '—');
                        document.getElementById('aspEstado').textContent = a.estado || '—';
                        document.getElementById('aspSegmento').textContent = a.segmento || '—';
                        document.getElementById('aspPrioridad').textContent = (a.prioridad ?? '—');
                        document.getElementById('aspCarrera').textContent = a.carrera_postulada || a.nombre_carrera || '—';
                        document.getElementById('aspCampus').textContent = a.campus || '—';

                        document.getElementById('aspiranteInfoPre').textContent =
                          JSON.stringify(a, null, 2);

                        const modalAsp = new bootstrap.Modal(document.getElementById('modalInfoAspirante'));
                        modalAsp.show();
                      } catch (e) {
                        alert('Error cargando aspirante: ' + e.message);
                      }
                    });
                  });
                }

                const modalView = new bootstrap.Modal(document.getElementById('modalVerCupos'));
                modalView.show();
              } catch (e) {
                alert('Error al obtener cupos: ' + e.message);
              }
            });
          });

          // Eliminar todos cupos
          document.querySelectorAll('.btn-eliminar-cupos').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('¿Eliminar todos los cupos de esta carrera? Esta acción puede afectar asignaciones.')) return;
              const id = btn.getAttribute('data-id');
              if (!id) return alert('Identificador de carrera no disponible.');

              try {
                await api(`/api/carreras/${encodeURIComponent(id)}/cupos`, { method: 'DELETE' });
                alert('Cupos eliminados.');
                await cargarColegios();
              } catch (e) {
                alert('Error al eliminar cupos: ' + e.message);
              }
            });
          });

        } catch (e) {
          console.error(e);
          alert('Error cargando carreras: ' + e.message);
        }
      }

      // Modal helpers editar cupos
      let carreraEditarId = null;
      const modalEditar = new bootstrap.Modal(document.getElementById('modalEditarCupos'));
      function abrirModalEditar(id, nombre, oferta, campus) {
        carreraEditarId = id;
        document.getElementById('editCarreraNombre').value = nombre;
        document.getElementById('editCarreraCampus').value = campus || '—';
        document.getElementById('editCuposActuales').value = oferta;
        document.getElementById('editNuevaOferta').value = oferta;
        document.getElementById('editError').classList.add('d-none');
        modalEditar.show();
      }

      document.getElementById('btnGuardarCupos')?.addEventListener('click', async () => {
        const nueva = parseInt(document.getElementById('editNuevaOferta').value);
        if (isNaN(nueva) || nueva < 0) {
          document.getElementById('editError').textContent = 'Introduce un número válido de cupos.';
          document.getElementById('editError').classList.remove('d-none');
          return;
        }
        try {
          const res = await api(`/api/carreras/${encodeURIComponent(carreraEditarId)}/update_oferta`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nueva_oferta: nueva })
          });
          if (res && res.ok) {
            modalEditar.hide();
            await cargarColegios();
            alert('Oferta actualizada correctamente.');
          } else {
            document.getElementById('editError').textContent = (res && res.error) ? res.error : 'No se pudo actualizar.';
            document.getElementById('editError').classList.remove('d-none');
          }
        } catch (e) {
          document.getElementById('editError').textContent = e.message;
          document.getElementById('editError').classList.remove('d-none');
        }
      });

      // Cargar aspirantes (panel)
      async function cargarAspirantes() {
        try {
          const list = await api('/api/aspirantes', { method: 'GET' });
          const tbody = document.querySelector('#tableAspirantes tbody');
          tbody.innerHTML = '';
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">No hay aspirantes.</td></tr>';
            return;
          }
          list.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.cedula}</td><td>${a.nombre}</td><td>${a.puntaje}</td><td>${a.estado}</td>`;
            tbody.appendChild(tr);
          });
        } catch (e) {
          alert('Error cargando aspirantes: ' + e.message);
        }
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/logout', { method: 'POST', credentials: 'include' });
        } finally {
          window.location = '/';
        }
      });

      // Segmentos globales modal logic
      let globalSegments = [];
      let modalGSeg = new bootstrap.Modal(document.getElementById('modalSegmentosGlobal'));

      async function abrirModalSegmentosGlobal() {
        document.getElementById('gsegError').classList.add('d-none');
        document.getElementById('segmentosGlobalList').innerHTML = '<p>Cargando...</p>';
        try {
          const res = await api('/api/segmentos', { method: 'GET' });
          globalSegments = res.segmentos || [];
          renderSegmentosGlobalList(globalSegments);
          modalGSeg.show();
        } catch (e) {
          alert('Error al cargar segmentos globales: ' + e.message);
        }
      }

      function renderSegmentosGlobalList(segs) {
        const cont = document.getElementById('segmentosGlobalList');
        if (!segs || segs.length === 0) {
          cont.innerHTML = '<p>No hay segmentos configurados.</p>';
          return;
        }
        let html = '<table class="table table-sm"><thead><tr><th>Orden</th><th>Nombre</th><th>%</th><th>Acciones</th></tr></thead><tbody>';
        segs.forEach(s => {
          html += `<tr>
            <td>${s.orden}</td>
            <td>${s.nombre}</td>
            <td>${s.porcentaje}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary btn-edit-gseg" data-json='${JSON.stringify(s).replace(/'/g,"&#39;")}'>Editar</button>
              <button class="btn btn-sm btn-outline-danger btn-del-gseg" data-nombre='${s.nombre}'>Eliminar</button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        cont.innerHTML = html;

        document.querySelectorAll('.btn-edit-gseg').forEach(b => {
          b.addEventListener('click', () => {
            const s = JSON.parse(b.getAttribute('data-json'));
            document.getElementById('gsegNombre').value = s.nombre;
            document.getElementById('gsegPorcentaje').value = s.porcentaje;
            document.getElementById('gsegOrden').value = s.orden;
          });
        });

        document.querySelectorAll('.btn-del-gseg').forEach(b => {
          b.addEventListener('click', async () => {
            if (!confirm('¿Eliminar segmento global?')) return;
            const nombre = b.getAttribute('data-nombre');
            try {
              await api(`/api/segmentos/${encodeURIComponent(nombre)}`, { method: 'DELETE' });
              const res = await api('/api/segmentos', { method: 'GET' });
              globalSegments = res.segmentos || [];
              renderSegmentosGlobalList(globalSegments);
            } catch (e) {
              alert('Error: ' + e.message);
            }
          });
        });
      }

      document.getElementById('formSegmentoGlobal')?.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const nombre = document.getElementById('gsegNombre').value.trim();
        const porcentaje = parseFloat(document.getElementById('gsegPorcentaje').value);
        const orden = parseInt(document.getElementById('gsegOrden').value, 10) || 100;
        if (!nombre || isNaN(porcentaje)) {
          document.getElementById('gsegError').textContent = 'Datos inválidos';
          document.getElementById('gsegError').classList.remove('d-none');
          return;
        }
        const idx = globalSegments.findIndex(s => s.nombre.trim().toLowerCase() === nombre.toLowerCase());
        if (idx >= 0) {
          globalSegments[idx].porcentaje = porcentaje;
          globalSegments[idx].orden = orden;
        } else {
          globalSegments.push({ nombre, porcentaje, orden });
        }
        renderSegmentosGlobalList(globalSegments);

        document.getElementById('gsegNombre').value = '';
        document.getElementById('gsegPorcentaje').value = '';
        document.getElementById('gsegOrden').value = '';
        document.getElementById('gsegError').classList.add('d-none');
      });

      document.getElementById('btnSaveGSeg')?.addEventListener('click', async () => {
        try {
          const suma = globalSegments.reduce((s, x) => s + (parseFloat(x.porcentaje) || 0), 0);
          if (Math.abs(suma - 100.0) > 0.0001) {
            alert('La suma de porcentajes debe ser 100. Actualmente: ' + suma);
            return;
          }
          await api('/api/segmentos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ segmentos: globalSegments })
          });
          modalGSeg.hide();
          alert('Segmentos globales guardados.');
        } catch (e) {
          alert('Error al guardar segmentos globales: ' + e.message);
        }
      });

      // Periodo: cargar y guardar
      async function cargarPeriodo() {
        try {
          const p = await api('/api/periodo');
          document.getElementById('periodoAnio').value = p.anio || '';
          document.getElementById('periodoNombre').value = p.periodo || '';
        } catch (e) {}
      }

      document.getElementById('btnGuardarPeriodo')?.addEventListener('click', async () => {
        const anio = document.getElementById('periodoAnio').value;
        const periodo = document.getElementById('periodoNombre').value;

        try {
          await api('/admin/periodo', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ anio, periodo })
          });
          alert("Período guardado correctamente");
        } catch (e) {
          alert(e.message);
        }
      });

      // Report: descarga real del Excel (blob)
      document.getElementById("btnReport")?.addEventListener("click", () => {
        fetch("/admin/report", { method: "POST", credentials: "include" })
          .then(res => {
            if (!res.ok) throw new Error("Error generando reporte");
            return res.blob();
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "reporte_cupos.xlsx";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
          })
          .catch(err => alert("Error: " + err.message));
      });

      // Arranque
      document.getElementById('menuUpload').click();
      cargarPeriodo();
    </script>
  </body>
</html>
```

