<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - CupoDrive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { min-height: 100vh; }
      .sidebar { width: 240px; }
      .content { margin-left: 250px; padding: 20px; }
      .pointer { cursor: pointer; }
    </style>
  </head>
  <body>
    <nav class="navbar bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">CupoDrive - Admin</a>
        <div class="d-flex">
          <span class="navbar-text text-light me-3">Bienvenido, {{ user.name }}</span>
          <button id="logoutBtn" class="btn btn-outline-light btn-sm">Cerrar sesión</button>
        </div>
      </div>
    </nav>

    <div class="d-flex">
      <div class="bg-light sidebar position-fixed vh-100 p-3">
        <h6>Menu</h6>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="#" class="nav-link" id="menuUpload">Subir CSV</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuCupos">Gestionar Cupos</a></li>
          <li class="nav-item"><a href="#" class="nav-link" id="menuAspirantes">Ver Aspirantes</a></li>
        </ul>
      </div>

      <div class="content flex-fill">
        <!-- Upload panel -->
        <div id="panelUpload">
          <h4>Subir archivos CSV</h4>
          <form id="uploadForm">
            <div class="mb-3">
              <label class="form-label">Archivo aspirantes (BaseDatos.csv)</label>
              <input id="fileAspirantes" name="aspirantes" type="file" class="form-control" accept=".csv">
            </div>
            <div class="mb-3">
              <label class="form-label">Archivo carreras (Carreras.csv)</label>
              <input id="fileCarreras" name="carreras" type="file" class="form-control" accept=".csv">
            </div>
            <button id="btnUpload" type="button" class="btn btn-primary">Subir y cargar</button>
            <span class="mx-2"></span>
            <button id="btnAssignAll" type="button" class="btn btn-success">Asignar cupos automáticamente</button>
            <button id="btnReport" type="button" class="btn btn-outline-secondary">Generar reporte</button>
          </form>
          <hr>
        </div>

        <!-- Cupos panel -->
        <div id="panelCupos" style="display:none;">
          <h4>Gestionar Cupos</h4>
          <div id="carrerasContainer" class="mb-3"></div>
          <div id="cuposContainer"></div>
        </div>

        <div id="panelAspirantes" style="display:none;">
          <h4>Lista de Aspirantes</h4>
          <table class="table table-sm" id="tableAspirantes">
            <thead><tr><th>Cédula</th><th>Nombre</th><th>Puntaje</th><th>Estado</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>

    <script>
      async function api(path, opts) {
        const res = await fetch(path, opts);
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || res.statusText);
        }
        return res.json();
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        await api('/logout', {method: 'POST'});
        window.location = '/';
      });

      // Menu handlers
      document.getElementById('menuUpload').addEventListener('click', () => {
        document.getElementById('panelUpload').style.display = 'block';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'none';
      });
      document.getElementById('menuCupos').addEventListener('click', () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'block';
        document.getElementById('panelAspirantes').style.display = 'none';
        loadCarreras();
      });
      document.getElementById('menuAspirantes').addEventListener('click', () => {
        document.getElementById('panelUpload').style.display = 'none';
        document.getElementById('panelCupos').style.display = 'none';
        document.getElementById('panelAspirantes').style.display = 'block';
        loadAspirantes();
      });

      // Upload files
      document.getElementById('btnUpload').addEventListener('click', async () => {
        const form = new FormData();
        const fAsp = document.getElementById('fileAspirantes').files[0];
        const fCarr = document.getElementById('fileCarreras').files[0];
        if (fAsp) form.append('aspirantes', fAsp);
        if (fCarr) form.append('carreras', fCarr);
        try {
          await api('/admin/upload', {method: 'POST', body: form});
          alert('Archivos cargados correctamente.');
        } catch (e) {
          alert('Error: ' + e.message);
        }
      });

      // Assign all
      document.getElementById('btnAssignAll').addEventListener('click', async () => {
        if (!confirm('¿Deseas ejecutar la asignación automática para todas las carreras?')) return;
        try {
          const res = await api('/admin/assign', {method: 'POST'});
          alert('Asignación completada. Revisa las carreras.');
          loadCarreras();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      });

      // Generate report
      document.getElementById('btnReport').addEventListener('click', async () => {
        try {
          await api('/admin/report', {method: 'POST'});
          alert('Reporte generado (se imprimirá en la consola del servidor).');
        } catch (e) {
          alert('Error: ' + e.message);
        }
      });

      // Load carreras and show buttons
      async function loadCarreras(){
        try {
          const carreras = await api('/api/carreras');
          const container = document.getElementById('carrerasContainer');
          container.innerHTML = '';
          if (!carreras.length) {
            container.innerHTML = '<div class="alert alert-warning">No hay carreras cargadas.</div>';
            return;
          }
          carreras.forEach(c => {
            const el = document.createElement('div');
            el.className = 'd-flex align-items-center mb-2';
            el.innerHTML = `
              <div class="flex-fill">
                <strong>${c.nombre}</strong> — Cupos: ${c.oferta_cupos} — Asignados: ${c.cupos_asignados}
              </div>
              <div>
                <button class="btn btn-sm btn-outline-primary me-2" data-id="${c.id}" onclick="verCupos('${c.id}')">Ver cupos</button>
                <button class="btn btn-sm btn-outline-danger" data-id="${c.id}" onclick="eliminarCuposCarrera('${c.id}')">Eliminar todos cupos</button>
              </div>
            `;
            container.appendChild(el);
          });
        } catch (e) {
          console.error(e);
          alert('Error cargando carreras: ' + e.message);
        }
      }

      // Ver cupos de carrera
      async function verCupos(id) {
        try {
          const res = await api('/api/carreras/' + encodeURIComponent(id) + '/cupos');
          const cont = document.getElementById('cuposContainer');
          let html = `<h5>Cupos - ${res.carrera}</h5>`;
          html += `<table class="table table-sm"><thead><tr><th>ID</th><th>Estado</th><th>Aspirante</th><th>Acciones</th></tr></thead><tbody>`;
          res.cupos.forEach(c => {
            const aspir = c.aspirante ? `${c.aspirante.cedula} — ${c.aspirante.nombre}` : '-';
            html += `<tr>
              <td>${c.id_cupo}</td>
              <td>${c.estado}</td>
              <td>${aspir}</td>
              <td>
                <button class="btn btn-sm btn-outline-warning" onclick="liberarCupo('${c.id_cupo}')">Liberar</button>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarCupo('${c.id_cupo}')">Eliminar</button>
              </td>
            </tr>`;
          });
          html += `</tbody></table>`;
          cont.innerHTML = html;
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Liberar cupo
      async function liberarCupo(id) {
        try {
          await api('/api/cupos/' + encodeURIComponent(id) + '/liberar', {method:'POST'});
          alert('Cupo liberado');
          loadCarreras();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Eliminar cupo
      async function eliminarCupo(id) {
        if (!confirm('¿Eliminar este cupo permanentemente?')) return;
        try {
          await api('/api/cupos/' + encodeURIComponent(id), {method:'DELETE'});
          alert('Cupo eliminado');
          loadCarreras();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Eliminar todos los cupos de una carrera (acción peligrosa)
      async function eliminarCuposCarrera(carreraId) {
        if (!confirm('¿Eliminar todos los cupos de esta carrera?')) return;
        // Se eliminarán individualmente (no hay endpoint para bulk), así que pedimos la lista y borramos cada uno.
        try {
          const res = await api('/api/carreras/' + encodeURIComponent(carreraId) + '/cupos');
          for (const c of res.cupos) {
            await api('/api/cupos/' + encodeURIComponent(c.id_cupo), {method: 'DELETE'});
          }
          alert('Todos los cupos eliminados para la carrera.');
          loadCarreras();
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Load aspirantes into table
      async function loadAspirantes(){
        // Si quieres, puedes añadir un endpoint que devuelva aspirantes; por ahora intentamos usar /admin/assign response or we show local upload file
        // Para simplicidad: avisamos al admin que use la subida para visualizar aspirantes
        const tbody = document.querySelector('#tableAspirantes tbody');
        tbody.innerHTML = '<tr><td colspan="4">Carga los aspirantes para ver la lista.</td></tr>';
      }

      // Inicializar vista: mostrar upload
      document.getElementById('menuUpload').click();
    </script>
  </body>
</html>
